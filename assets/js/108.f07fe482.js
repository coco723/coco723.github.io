(window.webpackJsonp=window.webpackJsonp||[]).push([[108],{528:function(s,a,e){"use strict";e.r(a);var n=e(2),t=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"怎样修改centos的ssh端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#怎样修改centos的ssh端口"}},[s._v("#")]),s._v(" 怎样修改CentOS的SSH端口")]),s._v(" "),a("h2",{attrs:{id:"场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#场景"}},[s._v("#")]),s._v(" 场景")]),s._v(" "),a("p",[s._v("一般centos默认的ssh登陆端口是22，很容易受到攻击登陆，为了安全型考虑，最好修改一下")]),s._v(" "),a("h2",{attrs:{id:"修改sshd-config端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改sshd-config端口"}},[s._v("#")]),s._v(" 修改sshd_config端口")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vi /etc/ssh/sshd_config\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("取消#PORT 22的注释，在下一行添加你需要修改的新端口Port 2048。（这里不删除22端口是为了防止修改后新端口无法访问，造成无法用 ssh 连接服务器）。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Port 22\nPort 2048\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("修改保存sshd_config文件后重启sshd服务")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("systemctl restart ssh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("退出ssh会话后，再用新的端口连接：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ ssh -p 2048 root@example.com\nssh: conntect to host 0.0.0.0 port 2048: Connection refused\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("好吧，native了...对于CentOS 7这一套修改端口的方法已经不能生效了。")]),s._v(" "),a("h2",{attrs:{id:"打开selinux端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#打开selinux端口"}},[s._v("#")]),s._v(" 打开"),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Security-Enhanced_Linux",target:"_blank",rel:"noopener noreferrer"}},[s._v("SELinux"),a("OutboundLink")],1),s._v("端口")]),s._v(" "),a("p",[s._v("SELinux全程Security Enhanced Linux(安全强化Linux)，是MAC（Mandatory Access Control，强制访问控制系统）的一个实现，目的在于明确的知名某个进程可以访问那些资源（文件、网络端口等）")]),s._v(" "),a("p",[s._v("对于ssh，SELinux默认只允许22端口，我们可以用SELinux管理配置工具semanage，来修改ssh可访问的端口")]),s._v(" "),a("p",[a("strong",[s._v("安装semanage工具")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ yum provides semanage\n$ yum -y install policycoreutils-python\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("为ssh打开2048端口")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 为 ssh 添加新的允许端口\n$ semanage port -a -t ssh_port_t -p tcp 2048\n# 查看当前 SELinux 允许的端口\n$ semanage port -l | grep ssh\nssh_port_t                     tcp      2048, 22  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("strong",[s._v("错误处理")])]),s._v(" "),a("p",[s._v("当SELINUX配置为禁用状态时，使用semanage回报错提示无法读取policy文件：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELinux:  Could not downgrade policy file /etc/selinux/targeted/policy/policy.30, searching for an older version.  \nSELinux:  Could not open policy file <= /etc/selinux/targeted/policy/policy.30:  No such file or directory  \n/sbin/load_policy:  Can't load policy:  No such file or directory\nlibsemanage.semanage_reload_policy: load_policy returned error code 2. (No such file or directory).  \nFileNotFoundError: [Errno 2] No such file or directory  \n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("修改/etc/selinux/config")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ vi /etc/selinux/config\nSELINUX=permissive  \n# 重启服务器\n$ init 6\n# 重启后查看 SELinux 状态\n$ sestatus\n# if it shows disable, you can run\n$ load_policy -qi\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("strong",[s._v("检查配置")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ semanage port -a -t ssh_port_t -p tcp 2048\n$ semanage port -l | grep ssh\nssh_port_t                     tcp      2048, 22  \n# 重启 ssh 服务\nsystemctl restart sshd  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("注：semanage不能禁用ssh的22端口")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ semanage port -d -t ssh_port_t -p tcp 22\nValueError: 在策略中定义了端口 tcp/22，无法删除。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"配置防火墙firewalld"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置防火墙firewalld"}},[s._v("#")]),s._v(" 配置防火墙firewalld")]),s._v(" "),a("h3",{attrs:{id:"启用防火墙-产看防火墙状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启用防火墙-产看防火墙状态"}},[s._v("#")]),s._v(" 启用防火墙 && 产看防火墙状态：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ systemctl enable firewalld\n$ systemctl start firewalld\n$ systemctl status firewalld\n● firewalld.service - firewalld - dynamic firewall daemon\n   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)\n   Active: active (running) since 二 2016-12-20 02:12:59 CST; 1 day 13h ago\n Main PID: 10379 (firewalld)\n   CGroup: /system.slice/firewalld.service\n           └─10379 /usr/bin/python -Es /usr/sbin/firewalld --nofork --nopid\n$ firewall-cmd --state\nrunning \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"查看防火墙当前默认和激活zone"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看防火墙当前默认和激活zone"}},[s._v("#")]),s._v(" 查看防火墙当前默认和激活zone：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ firewall-cmd --get-default-zone\npublic  \n$ firewall-cmd --get-active-zones\npublic  \n  interfaces: eth0 eth1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("若没有激活区域的话，要执行下面的命令")]),s._v(" "),a("h3",{attrs:{id:"激活public区域-增加网卡接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#激活public区域-增加网卡接口"}},[s._v("#")]),s._v(" 激活public区域，增加网卡接口")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ firewall-cmd --set-default-zone=public\n$ firewall-cmd --zone=public --add-interface=eth0\nsuccess  \n$ firewall-cmd --zone=public --add-interface=eth1\nsuccess  \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"为public-zone永久开放2048-tcp端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为public-zone永久开放2048-tcp端口"}},[s._v("#")]),s._v(" 为public zone永久开放2048/TCP端口")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 以防新端口不生效，先把 22 端口暴露\n$ firewall-cmd --permanent --zone=public --add-port=22/tcp\n$ firewall-cmd --permanent --zone=public --add-port=2048/tcp\nsuccess  \n# 重载防火墙\n$ firewall-cmd --reload\n# 查看暴露端口规则\n$ firewall-cmd --permanent --list-port\n443/tcp 80/tcp 22/tcp 2048/tcp  \n$ firewall-cmd --zone=public --list-all\npublic (default, active)  \n  interfaces: eth0 eth1\n  sources:\n  services: dhcpv6-client ssh\n  ports: 443/tcp 80/tcp 22/tcp 2048/tcp\n  masquerade: no\n  forward-ports:\n  icmp-blocks:\n  rich rules:\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("退出ssh后，尝试连接新端口")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ ssh -p 2048 root@example.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("成功登陆的话，就可以做收尾工作了。")]),s._v(" "),a("h2",{attrs:{id:"禁用22端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#禁用22端口"}},[s._v("#")]),s._v(" 禁用22端口")]),s._v(" "),a("h3",{attrs:{id:"删除ssh允许端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除ssh允许端口"}},[s._v("#")]),s._v(" 删除ssh允许端口")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('$ vi /etc/ssh/sshd_config\n#Port 22\nPort 2048  \n$ systemctl restart sshd\n# 用 ss 命令检查 ssh 监听的端口，没有 22 证明修改成功\n$ ss -tnlp | grep ssh\nLISTEN     0      128                       *:2048                    *:*      users:(("sshd",18233,3))  \n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"防火墙移除22端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#防火墙移除22端口"}},[s._v("#")]),s._v(" 防火墙移除22端口")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ firewall-cmd --permanent --zone=public --remove-port=22/tcp\nsuccess  \n$ firewall-cmd --reload\n$ firewall-cmd --permanent --list-port\n443/tcp 80/tcp 2048/tcp \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("ssh取消监听22端口，就已经配置好了，防火墙只不过是在ssh外多一层访问控制。如果要做的更好还可以将22端口的访问流量专项访问者本地：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ firewall-cmd --permanen --zone=public --add-forward-port=port=22:proto=tcp:toport=22:toaddr=127.0.0.1\n# 配置后重载防火墙，用 ssh -p 22 root@example.com 就会访问到自己本地的 22 端口。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("若要删除forward配置，可以：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ firewall-cmd --permanen --zone=public --remove-forward-port=port=22:proto=tcp:toport=22:toaddr=127.0.0.1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("检验修改ssh端口是否成功：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('$ ssh -p 22 root@example.com\n# 无响应，因为转到了本地的 22 端口\n# 若防火墙未 forward 连接，则会回显 "ssh: connect to host {ip} port 22: Connection refused"\n$ ssh -p 2048 root@example.com\n# 成功 success\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);